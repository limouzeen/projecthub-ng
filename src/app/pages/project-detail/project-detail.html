<section class="min-h-[100svh]">

  <!-- Top Toolbar -->
  <div class="sticky top-0 z-30 bg-white/70 border-b border-white/40 mb-8">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">

      <!-- menu button -->
      <button
        class="p-2 rounded-lg hover:bg-slate-100"
        (click)="toggleAside()"
        aria-label="Open sidebar"
        aria-controls="app-aside"
        [attr.aria-expanded]="asideOpen()">
        <svg class="w-5 h-5 text-slate-700" viewBox="0 0 24 24" fill="none">
          <path d="M3 6h18M3 12h18M3 18h18"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>

      <img src="/assets/h_noname_logo.png" class="w-7 h-7 rounded-lg shadow mr-2" alt="" />
      <span class="font-semibold text-slate-900">ProjectHub</span>

      <!-- Profile -->
<div class="ml-auto relative" (click)="$event.stopPropagation()">
  <button
    class="flex items-center gap-2 pl-2 pr-2 py-1 rounded-xl hover:bg-white/60 transition"
    (click)="toggleProfileMenu()"
    aria-haspopup="menu"
    [attr.aria-expanded]="profileOpen()">
    <img
      [src]="me()?.profilePictureUrl || '/assets/ph_profile.png'"
      alt="Profile"
      class="w-8 h-8 rounded-full ring-1 ring-white/60" />
  </button>

  @if (profileOpen()) {
    <div
      class="absolute right-0 top-full mt-2 w-72 rounded-2xl
             bg-white border border-white/40 shadow-md z-[70] overflow-hidden"
      role="menu">
      <div class="p-4 flex items-center gap-3">
        <img
          [src]="me()?.profilePictureUrl || '/assets/ph_profile.png'"
          alt=""
          class="w-12 h-12 rounded-full ring-1 ring-white/70" />
        <div class="min-w-0">
          <div class="font-semibold text-slate-900 truncate">
            {{ me()?.username || me()?.name || 'User' }}
          </div>
          <div class="text-xs text-slate-500 truncate">
            {{ me()?.email }}
          </div>
        </div>
      </div>
      <div class="h-px bg-gradient-to-r from-transparent via-slate-200 to-transparent"></div>
      <div class="p-2">
        <button
          class="w-full flex items-center gap-3 px-3 py-2 rounded-xl
                 hover:bg-slate-100/70 text-slate-700 transition"
          (click)="onEditProfile()">
          <svg class="w-5 h-5 text-indigo-500" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20h9"></path>
            <path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4 12.5-12.5z"></path>
          </svg>
          <span class="text-sm font-medium">Edit Profile</span>
        </button>

        <button
          class="w-full flex items-center gap-3 px-3 py-2 rounded-xl
                 hover:bg-rose-50 text-rose-600 transition"
          (click)="onLogout()">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <path d="M16 17l5-5-5-5"></path>
            <path d="M21 12H9"></path>
          </svg>
          <span class="text-sm font-medium">Logout</span>
        </button>
      </div>
    </div>
  }
</div>

    </div>
  </div>

  <!-- Overlay -->
  <div
    class="fixed inset-0 z-40 bg-black/40 transition-opacity duration-300"
    [class.opacity-0]="!asideOpen()"
    [class.pointer-events-none]="!asideOpen()"
    (click)="asideOpen.set(false)">
  </div>

  <!-- Drawer / Aside -->
  <aside
    id="app-aside"
    class="fixed left-0 top-0 bottom-0 z-50 w-80 max-w-[85vw] glass-subtle
           border border-white/40 backdrop-blur-lg transition-transform duration-300
           ease-out flex flex-col -translate-x-full"
    [class.translate-x-0]="asideOpen()"
    role="dialog"
    aria-label="Sidebar">
    <span class="aside-accent" aria-hidden="true"></span>

    <div class="px-4 py-3 flex items-center gap-2 border-b border-white/40">
      <img src="/assets/h_noname_logo.png" class="w-6 h-6 rounded-lg" alt="" />
      <div class="font-semibold">Menu</div>
      <button
        class="ml-auto p-2 rounded-lg hover:bg-slate-100"
        (click)="asideOpen.set(false)"
        aria-label="Close sidebar">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
          <path d="M6 6l12 12M18 6l-12 12"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>
    </div>

    <nav class="p-3 space-y-1 text-sm font-medium">
      <a routerLink="/dashboard" class="menu-item">
        <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             viewBox="0 0 24 24">
          <path d="M3 12l9-9 9 9M4 10v10a1 1 0 001 1h14a1 1 0 001-1V10" />
        </svg>
        Dashboard
      </a>

      <a routerLink="/recently-used" class="menu-item">
        <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             viewBox="0 0 24 24">
          <path d="M9 12h6M9 16h6M4 6h16M4 6v12a2 2 0 002 2h12a2 2 0 002-2V6" />
        </svg>
        Recently Used
      </a>

      <a routerLink="/favorites" class="menu-item">
        <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             viewBox="0 0 24 24">
          <path d="M12 8a4 4 0 100 8 4 4 0 000-8z" />
          <path
            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-.002.02-.002.04 0 .06C20.268 16.057 16.477 19 12 19c-4.477 0-8.268-2.943-9.542-7-.002-.02-.002-.04 0-.06z" />
        </svg>
        Favorite Project
      </a>


      <a routerLink="/guide" class="menu-item">
        <svg
          class="w-5 h-5 text-cyan-500"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          viewBox="0 0 24 24"
        >
          <path d="M4 19.5A2.5 2.5 0 016.5 17H20" />
          <path d="M4 4h16v13H6.5A2.5 2.5 0 004 19.5z" />
        </svg>
        Guidelines
      </a>
    </nav>

    <div class="mt-auto p-3">
      <div class="flex items-center justify-between text-xs">
        <div class="text-slate-500 select-none">© ProjectHub</div>
        <a
          routerLink="/about"
          (click)="asideOpen.set(false)"
          class="text-slate-500 hover:text-slate-700 rounded-lg px-2 py-1
                 hover:bg-white/50 border border-transparent hover:border-white/40
                 transition underline-offset-2 hover:underline"
          aria-label="About us">
          About us
        </a>
      </div>
    </div>
  </aside>

  <!-- Title row + search -->
  <div class="flex items-center justify-between max-w-5xl mx-auto mb-4">
    <div class="flex items-center gap-3">
      <button
        class="ph-back-pill"
        type="button"
        (click)="onBackToDashboard()">
        <span class="ph-back-pill-icon">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M14.5 5.5L8 12l6.5 6.5"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </span>
        <span class="ph-back-pill-label">Back</span>
      </button>

      <div class="text-xl font-semibold">Project tables</div>
    </div>

    <div class="flex gap-2">
      <input
        class="input w-56"
        placeholder="Filter tables..."
        [value]="q()"
        (input)="onSearch($any($event.target).value)" />
      <button
        class="btn-primary-enhance"
        (click)="openCreateDialog()"
        [disabled]="creating()">
        @if (creating()) {Creating...} @else {Create Table}
      </button>
    </div>
  </div>

  <!-- Main cards -->
  <div class="grid md:grid-cols-2 items-start gap-6 max-w-5xl mx-auto">
    <!-- Left: Tables -->
    <div class="glass rounded-3xl p-5 flex flex-col gap-3">
      <div class="text-sm text-slate-500">Tables</div>

      <!-- list with scroll when many items -->
      <div class="space-y-2 max-h-[420px] overflow-y-auto pr-1">
        @for (t of paged(); track t.tableId) {
          <div
            class="flex items-center justify-between gap-3
                   rounded-2xl px-3 py-2 bg-white/70 shadow
                   max-w-full overflow-hidden">
            <div class="font-medium text-slate-800 truncate min-w-0">
              {{ t.name }}
            </div>
            <div class="flex gap-2 flex-shrink-0">
              <button class="btn-ghost-enhance" (click)="open(t)">Open</button>
              <button
                class="btn-ghost-enhance"
                (click)="renameTable(t)"
                [disabled]="renamingId()===t.tableId">
                @if (renamingId()===t.tableId) {Renaming...} @else {Rename}
              </button>
              <button
                class="btn-ghost-enhance text-rose-600"
                (click)="deleteTable(t)"
                [disabled]="deletingId()===t.tableId">
                @if (deletingId()===t.tableId) {Deleting...} @else {Delete}
              </button>
            </div>
          </div>
        } @empty {
          <div class="text-sm text-slate-500">No tables yet.</div>
        }
      </div>

      @if (totalPages() > 1) {
        <div class="flex items-center justify-end gap-2 pt-1 text-xs text-slate-500">
          <button
            class="btn-ghost-enhance px-3 py-1"
            type="button"
            (click)="prevPage()"
            [disabled]="page() === 1">
            Prev
          </button>
          <span>Page {{ page() }} / {{ totalPages() }}</span>
          <button
            class="btn-ghost-enhance px-3 py-1"
            type="button"
            (click)="nextPage()"
            [disabled]="page() === totalPages()">
            Next
          </button>
        </div>
      }
    </div>

    <!-- Right: Tips -->
    <div class="glass rounded-3xl p-5 flex flex-col">
      <div class="text-sm text-slate-500 mb-3">Tips</div>
      <ul class="list-disc pl-4 text-sm text-slate-600 space-y-1">
        <li>
          ติ๊ก <strong>Auto-increment</strong> เพื่อให้ระบบสร้างคอลัมน์ <b>ID</b> (PK) ให้อัตโนมัติ
        </li>
        <li>
          หน้า Table-view จะล็อกฟิลด์ PK ไม่ให้แก้ไข และเวลากด Add Row จะดึงเลขรันอัตโนมัติ
        </li>
      </ul>
    </div>
  </div>

  <!-- Create Table Dialog -->
  <app-create-table-dialog
    [open]="dialogOpen()"
    (close)="dialogOpen.set(false)"
    (submit)="onCreateTable($event)">
  </app-create-table-dialog>



  <!-- Create Table Dialog -->
<app-create-table-dialog
  [open]="dialogOpen()"
  (close)="dialogOpen.set(false)"
  (submit)="onCreateTable($event)">
</app-create-table-dialog>

<!-- ================= Rename Table Dialog ================= -->
@if (renameDlgOpen()) {
  <div class="ph-tdlg-backdrop" (click)="closeRenameDialog()">
    <div class="ph-tdlg-wrap" (click)="$event.stopPropagation()">
      <div class="ph-tdlg-card">
        <h2 class="ph-tdlg-title">Rename table</h2>
        <p class="ph-tdlg-sub">
          ตั้งชื่อใหม่ให้ตารางของคุณ ช่วยให้อ่านง่ายและค้นหาได้สะดวกขึ้น
        </p>

        <div class="ph-tdlg-input-wrap">
          <label class="ph-tdlg-label">Table name</label>
          <input
            class="ph-tdlg-input"
            [value]="renameName()"
            (input)="renameName.set($any($event.target).value)"
            maxlength="100"
            autofocus />
        </div>

        <div class="ph-tdlg-actions">
          <button
            type="button"
            class="ph-btn ph-btn-ghost"
            (click)="closeRenameDialog()">
            Cancel
          </button>
          <button
            type="button"
            class="ph-btn ph-btn-primary"
            [disabled]="!renameName().trim() || !!renamingId()"
            (click)="confirmRenameTable()">
            @if (renamingId()) {Saving...} @else {Save}
          </button>
        </div>
      </div>
    </div>
  </div>
}

<!-- ================= Delete Table Dialog ================= -->
@if (deleteDlgOpen()) {
  <div class="ph-tdlg-backdrop" (click)="closeDeleteDialog()">
    <div class="ph-tdlg-wrap" (click)="$event.stopPropagation()">
      <div class="ph-tdlg-card ph-tdlg-danger">
        <h2 class="ph-tdlg-title">Delete table</h2>
        <p class="ph-tdlg-sub">
          คุณต้องการลบตาราง
          <strong>{{ targetTable()?.name }}</strong>
          ใช่หรือไม่? การลบนี้อาจทำให้ข้อมูลที่เกี่ยวข้องสูญหายถาวร
        </p>

        <div class="ph-tdlg-actions">
          <button
            type="button"
            class="ph-btn ph-btn-ghost"
            (click)="closeDeleteDialog()">
            Cancel
          </button>
          <button
            type="button"
            class="ph-btn ph-btn-danger"
            [disabled]="!!deletingId()"
            (click)="confirmDeleteTable()">
            @if (deletingId()) {Deleting...} @else {Delete}
          </button>
        </div>
      </div>
    </div>
  </div>
}

</section>
