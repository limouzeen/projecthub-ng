@if (open) {
<div class="overlay">
  <div class="dialog glass rounded-2xl p-5 max-w-2xl w-[92vw]">
    <div class="title">Add field</div>

    <form (submit)="$event.preventDefault()" class="space-y-4">
      <div class="grid sm:grid-cols-2 gap-3">
        <div>
          <label class="label">Field name</label>
          <input class="input mt-1" [(ngModel)]="name" name="name" placeholder="e.g. ProductName" />
        </div>

        <div>
          <label class="label">Type</label>
          <select class="input mt-1" [(ngModel)]="preset" name="preset" (change)="onPresetChange()">
            <option value="Identifier">Primary key (PK)</option>
            <option value="Text">Text</option>
            <option value="Number">Number</option>
            <option value="Price">Price</option>
            <option value="Date">Date</option>
            <option value="YesNo">Yes / No</option>
            <option value="Image">Image</option>
            <option value="Lookup">Lookup (Relate)</option>
            <option value="Formula">Formula</option>
          </select>
        </div>
      </div>

      <!-- Lookup config -->
      @if (preset === 'Lookup') {
      <div class="divider">Lookup</div>

      <div class="grid sm:grid-cols-2 gap-3">
        <!-- Target table -->
        <div>
          <label class="label">Target table</label>
          <select
            class="input mt-1"
            [(ngModel)]="targetTableId"
            name="targetTableId"
            (change)="onSelectTargetTable()"
          >
            <option [ngValue]="null">— Select —</option>
            @for (t of tables(); track t.tableId) {
            <option [ngValue]="t.tableId">{{ t.name }}</option>
            }
          </select>
        </div>

        <!-- Target column (แสดงค่าอะไรจาก table ปลายทาง) -->
        <div>
          <label class="label">Target column (display)</label>
          <select class="input mt-1" [(ngModel)]="targetColumnId" name="targetColumnId">
            <option [ngValue]="null">— Select —</option>
            @for (c of targetCols(); track c.columnId) {
            <option [ngValue]="c.columnId">{{ c.name }}</option>
            }
          </select>
        </div>
      </div>

      }

      <!-- Formula builder -->
      @if (preset === 'Formula') {
      <div class="divider">Formula</div>

      <div class="formula-grid">
        <!-- Left operand -->
        <div class="formula-block">
          <label class="label">Left operand (column)</label>
          <select class="input mt-1" [(ngModel)]="formulaLeftColumnId" name="formulaLeftColumnId">
            <option [ngValue]="null">— Select numeric column —</option>
            @for (c of numericCols(); track c.columnId) {
            <option [ngValue]="c.columnId">{{ c.name }}</option>
            }
          </select>
        </div>

        <!-- Operator -->
        <div class="formula-block">
          <label class="label">Operator</label>
          <div class="op-group mt-1">
            <button
              type="button"
              class="op-btn"
              [class.active]="formulaOp === '+'"
              (click)="setFormulaOp('+')"
            >
              +
            </button>
            <button
              type="button"
              class="op-btn"
              [class.active]="formulaOp === '-'"
              (click)="setFormulaOp('-')"
            >
              −
            </button>
            <button
              type="button"
              class="op-btn"
              [class.active]="formulaOp === '*'"
              (click)="setFormulaOp('*')"
            >
              ×
            </button>
            <button
              type="button"
              class="op-btn"
              [class.active]="formulaOp === '/'"
              (click)="setFormulaOp('/')"
            >
              ÷
            </button>
          </div>
        </div>

        <!-- Right operand -->
        <div class="formula-block">
          <label class="label">Right operand</label>

          <div class="flex items-center gap-4 mt-1 text-xs text-slate-600">
            <label class="inline-flex items-center gap-1">
              <input
                type="radio"
                name="formulaRightMode"
                value="column"
                [(ngModel)]="formulaRightMode"
              />
              <span>Column</span>
            </label>
            <label class="inline-flex items-center gap-1">
              <input
                type="radio"
                name="formulaRightMode"
                value="literal"
                [(ngModel)]="formulaRightMode"
              />
              <span>Value</span>
            </label>
          </div>

          @if (formulaRightMode === 'column') {
          <select class="input mt-1" [(ngModel)]="formulaRightColumnId" name="formulaRightColumnId">
            <option [ngValue]="null">— Select numeric column —</option>
            @for (c of numericCols(); track c.columnId) {
            <option [ngValue]="c.columnId">{{ c.name }}</option>
            }
          </select>
          } @else {
          <input
            class="input mt-1"
            type="number"
            [(ngModel)]="formulaRightLiteral"
            name="formulaRightLiteral"
            placeholder="e.g. 10"
          />
          }
        </div>
      </div>

      <div class="hint mt-2">
        เลือก Left / Operator / Right ให้ครบ ระบบจะสร้างสูตรในรูป JSON เองให้อัตโนมัติ
      </div>

      <div class="formula-preview" *ngIf="formulaPreview">
        <span class="label small">Preview JSON</span>
        <pre>{{ formulaPreview }}</pre>
      </div>
      }

      <!-- Advanced -->
      <details class="mt-2">
        <summary class="cursor-pointer select-none text-sm text-slate-600">Advanced</summary>
        <div class="grid sm:grid-cols-3 gap-3 mt-2">
          <label class="inline-flex items-center gap-2 text-sm">
            <input
              type="checkbox"
              [(ngModel)]="isPrimary"
              name="isPrimary"
              [disabled]="preset === 'Identifier' || preset === 'Formula'"
            />
            Use as identifier (PK)
          </label>
          <label class="inline-flex items-center gap-2 text-sm">
            <input
              type="checkbox"
              [(ngModel)]="isNullable"
              name="isNullable"
              [disabled]="preset === 'Identifier'"
            />
            Allow empty value
          </label>
          <div class="text-xs text-slate-500 flex items-center">
            Data type (backend):
            <code class="ml-1">{{ dataType }}</code>
          </div>
        </div>
      </details>

      <div class="flex gap-3 justify-end pt-2">
        <button class="btn-ghost-enhance" type="button" (click)="close()">Cancel</button>
        <button
          class="btn-primary-enhance"
          type="button"
          [disabled]="!canSubmit()"
          (click)="submit()"
        >
          Create field
        </button>
      </div>
    </form>
  </div>
</div>
}
